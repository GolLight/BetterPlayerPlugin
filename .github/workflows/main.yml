name: ğŸ§© Better Player æ’ä»¶è‡ªåŠ¨å‘å¸ƒ (Release)

# ä»…åœ¨æ¨é€ Tag æ—¶è§¦å‘ (ä¾‹å¦‚ v1.4.1.0)
on:
  push:
    tags:
      - 'v*.*.*'
  # å…è®¸æ‰‹åŠ¨åœ¨ Actions é¡µé¢è§¦å‘
  workflow_dispatch:

env:
  CS_PROJ_PATH: Jellyfin.Plugin.BetterPlayer/BetterPlayerPlugin/BetterPlayerPlugin.csproj
  MANIFEST_PATH: manifest.json
  PLUGIN_DLL: BetterPlayerPlugin.dll
  ZIP_NAME: BetterPlayerPlugin.zip

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»æœ‰å†™å…¥æƒé™æ‰èƒ½æäº¤ manifest å’Œåˆ›å»º release

    steps:
      # 1. ç¯å¢ƒå‡†å¤‡
      - name: â¬‡ï¸ æ£€å‡ºä»£ç  (Checkout code)
        uses: actions/checkout@v5.0.0
        with:
          # å¿…é¡»æ‹‰å–å®Œæ•´å†å²è®°å½•ï¼Œfetch-depth å¿…é¡»ä¸º 0
          fetch-depth: 0

      - name: âš™ï¸ è®¾ç½® .NET 9.0 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # 2. æå–ç‰ˆæœ¬å·å’Œ Changelog (å·²ä¿®æ­£ç‰ˆæœ¬èµ‹å€¼)
      - name: ğŸ”– æå–ç‰ˆæœ¬ä¿¡æ¯åŠ Changelog
        run: |
          # a. æå–å½“å‰ç‰ˆæœ¬ (V1.0.0.1 -> 1.0.0.1)
          VERSION_TAG_NAME="${{ github.ref_name }}"
          # æ­£ç¡®åœ°ç§»é™¤ 'v' å‰ç¼€å¹¶èµ‹å€¼ç»™ CURRENT_VERSION
          CURRENT_VERSION="${VERSION_TAG_NAME#v}" 
          
          echo "PLUGIN_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          echo "Current Version: $CURRENT_VERSION"
          
          # b. è·å–ä¸Šä¸€ä¸ª Tag
          # å…³é”®ä¿®æ­£ï¼šæŒ‰æ—¥æœŸæ’åºå¹¶ä½¿ç”¨ grep -v æ’é™¤å½“å‰æ­£åœ¨å¤„ç†çš„ Tag åç§°ï¼Œç„¶åå–ç¬¬ä¸€ä¸ª
          PREVIOUS_TAG=$(git for-each-ref --sort='-*creatordate' --format '%(refname:short)' refs/tags | grep -v "$VERSION_TAG_NAME" | sed -n 1p) || true
          
          echo "Previous Tag Found: $PREVIOUS_TAG"
          
          # c. æå– Changelog
          if [ -z "$PREVIOUS_TAG" ]; then
            # å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ª Tag (ç¬¬ä¸€æ¬¡å‘å¸ƒ)
            CHANGELOG=$(git log --pretty=format:"* %s" | sed ':a;N;$!ba;s/\n/\\n/g')
            echo "æœªæ‰¾åˆ°ä¸Šä¸€ä¸ª Tagï¼Œä½¿ç”¨æ‰€æœ‰ Commit æ¶ˆæ¯ä½œä¸º Changelogã€‚"
          else
            # ä»ä¸Šä¸€ä¸ª Tag åˆ°å½“å‰ Commit ä¹‹é—´çš„ commits
            CHANGELOG=$(git log "$PREVIOUS_TAG"..HEAD --pretty=format:"* %s" | sed ':a;N;$!ba;s/\n/\\n/g')
            echo "Changelog å·²ä» $PREVIOUS_TAG æå–ã€‚"
          fi
          
          # å°† CHANGELOG ç»“æœå­˜å…¥ç¯å¢ƒå˜é‡
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 3. æ›´æ–° .csproj ç‰ˆæœ¬
      - name: ğŸ†™ æ›´æ–° .csproj ç‰ˆæœ¬å·
        uses: rvolo/xml-replace-action@v0.3
        with:
          filepath: "${{ env.CS_PROJ_PATH }}"
          xpath: "/Project/PropertyGroup/Version/text()"
          replace: "${{ env.PLUGIN_VERSION }}"

      # 4. æ„å»ºé¡¹ç›®
      - name: ğŸ—ï¸ æ„å»ºæ’ä»¶ (dotnet build)
        run: dotnet build "${{ env.CS_PROJ_PATH }}" -c Release

      # 5. æ‰“åŒ… ZIP æ–‡ä»¶ (ä»…æ‰“åŒ… DLL)
      - name: ğŸ“¦ æ‰“åŒ…æ’ä»¶ ZIP (ä»… DLL)
        run: |
          pwd
          # åˆ‡æ¢åˆ°æ„å»ºè¾“å‡ºç›®å½•
          BUILD_PATH="Jellyfin.Plugin.BetterPlayer/BetterPlayerPlugin/bin/Release/net9.0"
          cd "$BUILD_PATH"

          # ZIP æ–‡ä»¶è¾“å‡ºåˆ°ä»“åº“æ ¹ç›®å½•
          ZIP_OUTPUT="${{ github.workspace }}/${{ env.ZIP_NAME }}"

          # ä½¿ç”¨ zip å‘½ä»¤ï¼Œåªæ‰“åŒ…æ ¸å¿ƒ DLL æ–‡ä»¶
          zip "$ZIP_OUTPUT" ${{ env.PLUGIN_DLL }}

          # è¿”å›ä»“åº“æ ¹ç›®å½•
          cd - > /dev/null
          pwd
          
          echo "ZIP æ–‡ä»¶å·²åˆ›å»º: ${{ env.ZIP_NAME }}"

      # 6. æ›´æ–° manifest.json æ–‡ä»¶ - æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†
      - name: ğŸ“ æ›´æ–° manifest.json (æ–°å¢ç‰ˆæœ¬å¯¹è±¡)
        run: |
          sudo apt-get install -y jq

          # a. è®¡ç®—å¤§å†™ MD5 æ ¡éªŒå’Œ
          MD5_UPPER=$(md5sum "${{ env.ZIP_NAME }}" | awk '{print $1}' | tr '[:lower:]' '[:upper:]')
          echo "Calculated MD5: $MD5_UPPER"
          
          # b. è·å–å½“å‰ UTC æ—¶é—´æˆ³
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # c. æ„å»ºæ–°çš„ç‰ˆæœ¬å¯¹è±¡ (JSON å­—ç¬¦ä¸²)
          # æ³¨æ„ï¼šæ­¤å¤„éœ€è¦å¯¹ CHANGELOG è¿›è¡Œè½¬ä¹‰å¤„ç†ï¼Œä»¥ä¾¿å…¶ä½œä¸º JSON å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†
          CHANGELOG_ESCAPED=$(echo -e "${{ env.CHANGELOG }}" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          NEW_VERSION_JSON="{
            \"version\": \"${{ env.PLUGIN_VERSION }}\",
            \"changelog\": \"$CHANGELOG_ESCAPED\",
            \"targetAbi\": \"10.11.0.0\",
            \"sourceUrl\": \"https://github.com/GolLight/BetterPlayerPlugin/releases/download/v${{ env.PLUGIN_VERSION }}/${{ env.ZIP_NAME }}\",
            \"checksum\": \"$MD5_UPPER\",
            \"timestamp\": \"$TIMESTAMP\"
          }"

          # d. ä½¿ç”¨ jq å°†æ–°å¯¹è±¡æ·»åŠ åˆ° versions æ•°ç»„çš„å¼€å¤´ (prepend)
          jq --argjson new_version "$NEW_VERSION_JSON" \
             '.[0].versions |= [ $new_version ] + .' ${{ env.MANIFEST_PATH }} > manifest_updated.json
             
          mv manifest_updated.json ${{ env.MANIFEST_PATH }}

      # 7. æäº¤ manifest.json å’Œ .csproj
      - name: ğŸ’¾ æäº¤æ›´æ–°åçš„æ–‡ä»¶
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add ${{ env.MANIFEST_PATH }}
          git add ${{ env.CS_PROJ_PATH }}
          git diff
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ”¹åŠ¨ï¼Œæ²¡æœ‰åˆ™ä¸æ‰§è¡Œ commit
          git diff --quiet --exit-code || git commit -m "chore(release): Update manifest and csproj for v${{ env.PLUGIN_VERSION }} release."
          # git push

      # 8. åˆ›å»º GitHub Release
      - name: ğŸ·ï¸ åˆ›å»º GitHub Release å¹¶ä¸Šä¼ èµ„äº§
        uses: softprops/action-gh-release@v2.4.1
        with:
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          files: ${{ env.ZIP_NAME }}
